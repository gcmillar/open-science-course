<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>NCSU GIS 610-003/603: Tools for open geospatial science</title>

<link rel="shortcut icon" href="../img/favicon.png" />

<link href="../layout.css" rel="stylesheet" type="text/css" media="screen">
<link href="../style.css" rel="stylesheet" type="text/css" media="screen">

</head>

<body>

<div id="outercontainer">
<div id="container">

<header>
<div id="header-image">
</div>

<nav>
<ul class="nav">
<li><a href="../index.html">Syllabus</a></li>
<li><a href="../index.html#schedule">Schedule</a></li>
</ul>
</nav>

</header>

<main>
<!-- This is a generated file. Do not edit. -->
<h1 id="publishing-data-on-web">Publishing data on web</h1>
<p>To publish scientific data online, we have several choices based on the discipline and type of data. The resources section lists several repositories which are either general or with some geospatial focus. For the practical part, we will try an absolutely general method which does not use a centralized scientific repository, but which is applicable also for non-scientific geospatial data.</p>
<h2 id="custom-web-page-with-geospatial-data">Custom web page with geospatial data</h2>
<h3 id="preparation">Preparation</h3>
<p>Install GDAL (command for Ubuntu):</p>
<pre><code>sudo apt install gdal-bin</code></pre>
<p>Get data and upack them:</p>
<pre><code>wget http://grass.osgeo.org/sampledata/north_carolina/nc_rast_geotiff.tar.gz
wget http://grass.osgeo.org/sampledata/north_carolina/nc_shape.tar.gz
tar xvf nc_rast_geotiff.tar.gz
tar xvf nc_shape.tar.gz</code></pre>
<p>Covert Shapefile to GeoJSON:</p>
<pre><code>ogr2ogr -f GeoJSON -t_srs crs:84 nc_state.geojson ncshape/nc_state.shp</code></pre>
<h3 id="web-page">Web page</h3>
<p>Now create a file in a text editor with the following HTML code, name the file <code>index.html</code> and open this file in a web browser (the page will be empty):</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;OpenLayers simple raster and vector&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://openlayers.org/en/v4.3.4/css/ol.css&quot; type=&quot;text/css&quot;&gt;
    &lt;!-- The line below is only needed for old environments like Internet Explorer and Android 4.x --&gt;
    &lt;script src=&quot;https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://openlayers.org/en/v4.3.4/build/ol.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js&quot;&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;map&quot; class=&quot;map&quot;&gt;&lt;/div&gt;
    &lt;script&gt;
        /* JavaScript goes here */
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>The first half of the file links to OpenLayers JavaScript mapping library (CSS files and JavaScript files). The second half is mostly empty and we will fill it now.</p>
<p>Here is the basic JavaScript code to get OpenStreetMap as a base map:</p>
<pre><code>var map = new ol.Map({
  layers: [
    new ol.layer.Tile({
      source: new ol.source.OSM()
    })
  ],
  target: &#39;map&#39;,
  controls: ol.control.defaults({
      attributionOptions: ({
      collapsible: false
    })
  }),
  view: new ol.View({
    projection: &#39;EPSG:4326&#39;,
    center: [0, 0],
    zoom: 2
  })
});</code></pre>
<p>Now would be the time to reload the page in the web browser (usually Ctrl+R). If you don't see anything or something else is not right, you may want to explore developer tools in your web browser (see below). Than we can add code to load our GeoJSON file before the code for OpenStreetMap:</p>
<pre><code>var vectorSource = new ol.source.Vector({
  format: new ol.format.GeoJSON(),
  url: &#39;nc_state.geojson&#39;,
  attributions: &quot;NC Boundary: Neteler &amp;amp; Mitasova 2008&quot;
});
var vectorLayer = new ol.layer.Vector({
  source: vectorSource
});</code></pre>
<p>We need to edit the list of layers in the code add the GeoJSON:</p>
<pre><code>var map = new ol.Map({
    layers: [
      new ol.layer.Tile({
        source: new ol.source.OSM()
      }),
      vectorLayer
    ],</code></pre>
<p>Now you can look again in the web browser and you should see the borders of North Carolina as a separate layer.</p>
<p>If you don't see it the reason might error in your JavaScript code or the reason might be same-origin policy in you web browser. You can tell the difference by starting developer tools in your web browser and looking at messages in the console or log (e.g. in Firefox, Tools -&gt; Web Developer -&gt; Toggle Tools -&gt; Console). Firefox <a href="https://developer.mozilla.org/en-US/docs/Same-origin_policy_for_file:_URIs">policy</a> allows for a local file in the same directory to be loaded, so you should be good to go when using Firefox. However, Chrome and Chromium require a special command line option (replace <code>chromium-browser</code> by <code>chrome</code> or path to it if needed):</p>
<pre><code>chromium-browser --disable-web-security --user-data-dir</code></pre>
<h3 id="converting-raster-and-its-extracting-metadata">Converting raster and its extracting metadata</h3>
<p>To make sharing of the geospatial data easier, we will again convert to CRS:84. For that we will use <em>gdalwarp</em>. However, PNG cannot be written directly using <em>gdalwarp</em> with the current version of GDAL, so we first write a GDAL virtual dataset (VRT) and then we use <em>gdal_translate</em> to convert the reprojected VRT to PNG.</p>
<pre><code>gdalwarp -of VRT -r average -t_srs crs:84 ncrast/elev_state_500m.tif elev_state_500m.vrt
gdal_translate -of PNG elev_state_500m.vrt elev_state_500m.png</code></pre>
<p>We are using PNG because unlike TIFF, web browsers can display it. However, the PNG file itself does not carry the geospatial metadata (unlike GeoTIFF). Therefore, we need to get the information from the metadata and put it to JavaScript code manually. We already know the coordinate reference system (but we can check it). What we need to get is the extent and we can do that using <em>gdalinfo</em>:</p>
<pre><code>gdalinfo elev_state_500m.png</code></pre>
<p>All we need is <code>Lower Left</code> and <code>Upper Right</code> and we could just copy the numbers to the JavaScript code in the next section. However, for this exercise, we will extract the extent in an automated way. If you can't get GDAL version 2 or <em>jq</em> (see below), you can skip executing commands in this part and just read through it (but you should be good to go if you are using, e.g. an Ubuntu machine from NCSU VCL).</p>
<p>What we want to get is the following line:</p>
<pre><code>[-84.4223856,  33.4882788, -75.0518788,  36.6207207]</code></pre>
<p>The previous <em>gdalinfo</em> command gives output which can be processed by <em>grep</em> and other command line tools, but the output format may not be guaranteed to stay the same, so a new version may not work with command based on it. For this reason we will use a more stable JSON output offered by <em>gdalinfo</em>. For this, we need GDAL version 2 or higher, so you need to make sure you have it. For example, on Ubuntu 16.04, the version of GDAL is 1, so we need to add a PPA (Personal Package Archive) repository which provides a more recent version of GDAL with the cost of potential less stability within thesoftware or in relation to other installed software. The commands to do it follow:</p>
<pre><code>sudo add-apt-repository ppa:ubuntugis/ubuntugis-unstable
sudo apt update
sudo apt upgrade</code></pre>
<p>Now, with GDAL version 2 or higher, we can use the <code>-json</code> option to obtain JSON output:</p>
<pre><code>gdalinfo -json elev_state_500m.png</code></pre>
<p>JSON is not easily parseable with tools such as <em>grep</em>, however there is a tool called <em>jq</em> which works in a similar way as <em>grep</em> and other tools but for JSON. Here is an installation command for Ubuntu:</p>
<pre><code>sudo apt install jq</code></pre>
<p>Now we can use <em>jq</em> and pipes in the same way we would use <em>grep</em>. JSON format consists of keys and values in dictionaries where values can be strings, numbers, lists, or dictionaries. Using the <code>.key</code> syntax we get only the value associated with the given key:</p>
<pre><code>gdalinfo -json elev_state_500m.png | jq .cornerCoordinates</code></pre>
<p>We can pipe the output again to <em>jq</em> and get values for two keys using <code>.oneKey, .anotherKey</code> syntax:</p>
<pre><code>gdalinfo -json elev_state_500m.png | jq .cornerCoordinates | \
    jq &quot;.lowerLeft, .upperRight&quot;</code></pre>
<p>This gives us all information we need but not formated exactly as we want it, i.e. a single list in one line, so we use <em>tr</em> to replace newlines by spaces (<code>tr &quot;\n&quot; &quot; &quot;</code>), <em>sed</em> to replace <code>] [</code> by comma (using expression <code>/\] \[/,/</code>), and finally we use tr again to squeeze all repeated spaces into one:</p>
<pre><code>gdalinfo -json elev_state_500m.png | jq .cornerCoordinates | \
    jq &quot;.lowerLeft, .upperRight&quot; | \
    tr &quot;\n&quot; &quot; &quot; | sed -e &quot;s/\] \[/,/g&quot; | tr -s &quot; &quot;</code></pre>
<p>Alternatively, we can leverage more the <em>jq</em> command. The <em>jq</em> command itself has a pipe syntax which has similar logic to the command line pipes, so we can actually write expression <code>.cornerCoordinates | lowerLeft, .upperRight</code>. To merge the two separate list (which are the values <code>.lowerLeft</code> and <code>.upperRight</code>), we can use the plus operator in the <em>jq</em> expression (<code>lowerLeft + .upperRight</code>). To avoid <em>jq</em> default formatting with one list item per line, we use <code>-c</code> to create compact output. Then we use <em>sed</em> just to replace comma by comma followed by a space (expression <code>/,/, /</code>) to have a better coding style in the JavaScript code:</p>
<pre><code>gdalinfo -json elev_state_500m.png | \
    jq -c &quot;.cornerCoordinates | [.lowerLeft[], .upperRight[]]&quot; | \
    sed &quot;s/,/, /g&quot;</code></pre>
<p>You can learn more about <em>jq</em> online or using:</p>
<pre><code>man jq</code></pre>
<p>Same applies to <em>tr</em> and <em>sed</em> but using the <em>info</em> command instead of the <em>man</em> command will give you full documentation:</p>
<pre><code>info tr</code></pre>
<h3 id="adding-raster">Adding raster</h3>
<p>Now, we can add the JavaScript code to the web page:</p>
<pre><code>var imageExtent = [-84.4223856, 33.4882788, -75.0518788, 36.6207207];
var rasterLayer = new ol.layer.Image({
      source: new ol.source.ImageStatic({
        url: &#39;elev_state_500m.png&#39;,
        crossOrigin: &#39;&#39;,
        projection: &#39;CRS:84&#39;,
        imageExtent: imageExtent,
        attributions: &quot;NC Elevation: Neteler &amp;amp; Mitasova 2008&quot;
      })});</code></pre>
<p>We need to edit the list of layers again to add the raster:</p>
<pre><code>var map = new ol.Map({
    layers: [
      new ol.layer.Tile({
        source: new ol.source.OSM()
      }),
      rasterLayer,
      vectorLayer
    ],</code></pre>
<p>See the complete web page <a href="../resources/openlayers_raster_and_vector.html">here</a> and compare it with yours (you can see the code of the page in your web browsers; usually using Ctrl+U).</p>
<h3 id="publishing-with-github">Publishing with GitHub</h3>
<p>Now we will publish the web page using GitHub, specifically GitHub Pages service which can be activated for any Git repository on GitHub.</p>
<p>Install Git on your local machine (command for Ubuntu):</p>
<pre><code>sudo apt install git</code></pre>
<p>Create a repository on GitHub. You will need write access to the repository, so you need to use HTTPS and know your GitHub password or set up SSH keys. If you are on a machine which is not yours (like NCSU VCL machine), HTTPS will be easiest. Alternatively, just login to GitHub (in a web browser) and use direct upload (e.g. with drag and drop).</p>
<p>Now clone the repository. We will call it <code>openlayers-test</code> (<code>...</code> stands for URL of the repository).</p>
<pre><code>git clone ... openlayers-test</code></pre>
<p>Move the web page files into the repository, i.e. the HTML file, the PNG file, and the GeoJSON file. Then change the directory to the repository. You can use <em>mv</em> and <em>cd</em> to do that:</p>
<pre><code>mv index.html openlayers-test
mv nc_state.geojson openlayers-test
mv elev_state_500m.png openlayers-test
cd openlayers-test</code></pre>
<p>Add the files to the repository:</p>
<pre><code>git add index.html nc_state.geojson elev_state_500m.png</code></pre>
<p>Now you can commit and push:</p>
<pre><code>git commit ...
git push</code></pre>
<p>Now go to the repository page on GitHub in your web browser, go to <em>Settings</em> and in <em>Options</em> (loaded by default) find <em>GitHub Pages</em>. In <em>Source</em> select <em>master branch</em>, then click <em>Save</em>. Wait for the page to reload and show you the URL of the newly created web site which is at yourusername.github.io/repository-name.</p>
<h3 id="colorize-the-raster-and-examine-the-change-on-github">Colorize the raster and examine the change on GitHub</h3>
<p>Now let's change the color table of the raster. For that we will use <em>gdaldem</em> which accepts color tables in format one value-color pair per line (similar format to what e.g. GRASS GIS uses).</p>
<p>The color table needs to be in a file. We can create a file from command line without using a text editor, just by copy pasting the following command line code block (all lines together):</p>
<pre><code>cat &gt; colors.txt &lt;&lt;EOF
100% 255 255 255
60%  235 220 175
40%  190 185 135
5%   240 250 150
0     50 180  50
nv   0 0 0 0
EOF</code></pre>
<p>The above code uses what is called <em>here-document</em>. The <code>&lt;&lt;EOF</code> part starts a content of a file and all is part of this file until the line which says <code>EOF</code>. This file (here-document) is used as input to <em>cat</em> command which writes it to an actual file on the disk (<code>cat &gt; colors.txt</code>).</p>
<p>We use <em>gdaldem</em> in the <code>color-relief</code> mode, use the VRT dataset as input, and output PNG (change the path to files as needed):</p>
<pre><code>gdaldem color-relief -of PNG elev_state_500m.vrt colors.txt elev_state_500m.png -alpha</code></pre>
<p>The <code>-alpha</code> option ensures that an alpha channel (transparency and opacity) is written to the PNG file and together with <code>nv 0 0 0 0</code> line in color table file, it ensures that NULL values are transparent.</p>
<p>Then commit the change in the PNG file and push:</p>
<pre><code>git commit elev_state_500m.png ...
git push</code></pre>
<p>Finally, go to GitHub and find the commit (change) you just made. While Git in command line can't show differences in binary files such as PNGs, GitHub has several different ways of exploring changes in selected binary formats including PNGs.</p>
<h2 id="resources">Resources</h2>
<h3 id="repositories">Repositories</h3>
<ul>
<li><a href="https://osf.io/a5imq/wiki/How%20to%20Upload%20Data%20to%20the%20OSF">How to deposit data on the OSF</a> (part of Reproducibility Project: Cancer Biology)</li>
<li><a href="https://intercom.help/authorea/host-data">Hosting Data on Authorea</a> (Authorea help pages)</li>
<li><a href="https://support.figshare.com/support/solutions/folders/6000200032">Getting started with figshare: How to's</a> (figshare Support pages)</li>
<li><a href="http://datadryad.org/pages/faq">Dryad Digital Repository: Frequently Asked Questions</a></li>
<li><a href="http://zenodo.org/">Zenodo</a></li>
<li><a href="https://data.world/">data.world</a></li>
<li><a href="http://hydroshare.org/">Hydroshare</a></li>
<li><a href="http://opentopography.org/">OpenTopography</a></li>
<li><a href="https://www.nature.com/sdata/policies/repositories">Recommended Data Repositories by Nature</a></li>
</ul>
<h3 id="other">Other</h3>
<ul>
<li><a href="https://help.github.com/articles/rendering-and-diffing-images/">Rendering and diffing images on GitHub</a></li>
<li><a href="https://help.github.com/articles/mapping-geojson-files-on-github/">Mapping GeoJSON files on GitHub</a></li>
<li><a href="http://epsg.io/">EPSG.io</a> (Coordinate Systems Worldwide)</li>
<li><a href="http://openlayers.org/">OpenLayers</a></li>
</ul>
<h2 id="assignment">Assignment</h2>
<p>Explore the general repositories for scientific data linked above and search for a repository which is used in your field. If you find something what is not on the list, you can share it on the message board.</p>
<p>Then go through the instructions to create your own simple, but interactive web map showing a raster and vector and publish it through GitHub. Send the link to the repository and to the web page online to the message board.</p>

</main>

<footer>

<nav>
<ul>
<li>
    <li><a class="term-changes" href="https://moodle-courses1718.wolfware.ncsu.edu/course/view.php?id=1806">Moodle site</a></li>
    <li><a href="http://help.ncsu.edu/">Computing Help</a></li>
    <li><a href="http://geospatial.ncsu.edu/">GIST Home</a></li>
    <li><a href="http://www.ncsu.edu/policies/prr-disclaimer.php">Disclaimer</a></li>
    <li><a href="http://oit.ncsu.edu/itaccess">Accessibility</a></li>
    <a href="https://github.com/ncsu-geoforall-lab/open-science-course" title="Fork on GitHub" alt="octocat">
        <img src="../img/github_logo.png">
    </a>
</li>
<li title="Copyright and license (not applicable to linked materials)">
    &copy; 2017
    <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA</a>
    <a href="http://geospatial.ncsu.edu/osgeorel/">NCSU GeoForAll Lab</a>
</li>
</ul>
</nav>

</footer>

</div>
</div>

</body>
</html>
